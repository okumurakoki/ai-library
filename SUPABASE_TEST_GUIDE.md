# Supabase統合機能 テストガイド

このガイドでは、実装したSupabase統合機能の動作確認方法を説明します。

## 📋 目次

1. [事前準備](#事前準備)
2. [お気に入り機能のテスト](#お気に入り機能のテスト)
3. [カスタムプロンプト機能のテスト](#カスタムプロンプト機能のテスト)
4. [フォルダ機能のテスト](#フォルダ機能のテスト)
5. [記事機能のテスト](#記事機能のテスト)
6. [統計機能のテスト](#統計機能のテスト)
7. [デバイス間同期のテスト](#デバイス間同期のテスト)

---

## 事前準備

### 1. Supabaseテーブルの作成

Supabaseダッシュボードの SQL Editor で以下を実行:

```sql
-- supabase-schema-simple.sql の内容を実行
-- 以下のテーブルが作成されます:
-- - prompts (プロンプトマスター)
-- - user_favorites (お気に入り)
-- - custom_prompts (カスタムプロンプト)
-- - user_folders (フォルダ)
-- - articles (記事)
-- - copy_logs (プロンプトコピーログ)
-- - search_history (検索履歴)
```

### 2. 環境変数の確認

`.env` ファイルに以下が設定されていることを確認:

```env
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

### 3. アプリケーション起動

```bash
npm run dev
```

---

## お気に入り機能のテスト

### テスト手順

1. **ログイン前の動作確認**
   - ログアウト状態でアプリにアクセス
   - プロンプトをお気に入りに追加
   - ブラウザのlocalStorageに保存されていることを確認
     - DevTools → Application → Local Storage → `ai-library-favorites`

2. **ログイン後の自動マイグレーション**
   - Clerkでログイン
   - localStorageのお気に入りが自動的にSupabaseに移行される
   - localStorageの `ai-library-favorites` が削除される

3. **Supabaseへの保存確認**
   - プロンプトを新しくお気に入りに追加
   - Supabaseダッシュボード → Table Editor → `user_favorites` を開く
   - 自分の `user_id` でレコードが追加されていることを確認

4. **お気に入り解除**
   - お気に入りを解除
   - Supabaseから該当レコードが削除されていることを確認

### 確認ポイント

✅ お気に入り追加時に即座にSupabaseに保存される
✅ ページリロード後もお気に入りが保持される
✅ localStorageからSupabaseへの移行が1回だけ実行される
✅ お気に入りページで正しく表示される

---

## カスタムプロンプト機能のテスト

### テスト手順

1. **カスタムプロンプトの作成**
   - サイドバーの「作成したプロンプト」をクリック
   - 「新規プロンプト作成」ボタンをクリック
   - プロンプトの情報を入力して保存

2. **Supabaseへの保存確認**
   - Supabaseダッシュボード → `custom_prompts` テーブルを確認
   - 以下のフィールドが正しく保存されているか確認:
     - `id`: プロンプトID
     - `user_id`: ユーザーID
     - `title`: タイトル
     - `content`: 内容
     - `category`: カテゴリ
     - `tags`: タグ配列
     - `created_at`: 作成日時

3. **カスタムプロンプトの編集**
   - 作成したプロンプトの編集ボタンをクリック
   - 内容を変更して保存
   - Supabaseで `updated_at` が更新されていることを確認

4. **カスタムプロンプトの削除**
   - プロンプトを削除
   - Supabaseから削除されていることを確認

### 確認ポイント

✅ カスタムプロンプトがSupabaseに保存される
✅ 編集が正しく反映される
✅ 削除が正しく実行される
✅ 「作成したプロンプト」ページで一覧表示される

---

## フォルダ機能のテスト

### テスト手順

1. **フォルダの作成**
   - サイドバーの「フォルダ管理」をクリック
   - 「新規フォルダ作成」ボタンをクリック
   - フォルダ名を入力して作成

2. **Supabaseへの保存確認**
   - Supabaseダッシュボード → `user_folders` テーブルを確認
   - フォルダが保存されていることを確認

3. **プロンプトをフォルダに追加**
   - プロンプトカードの「フォルダに追加」をクリック
   - 作成したフォルダを選択
   - Supabaseで `prompt_ids` 配列にプロンプトIDが追加されていることを確認

4. **フォルダから表示**
   - サイドバーでフォルダをクリック
   - フォルダ内のプロンプトが表示されることを確認

5. **フォルダ名の変更**
   - フォルダ管理ダイアログでフォルダ名を変更
   - Supabaseで更新されていることを確認

6. **フォルダの削除**
   - フォルダを削除
   - Supabaseから削除されていることを確認

### 確認ポイント

✅ フォルダの作成・編集・削除が正しく動作
✅ プロンプトの追加・削除が正しく動作
✅ フォルダごとのプロンプト表示が正しく動作

---

## 記事機能のテスト

### テスト手順

#### 一般ユーザー向け

1. **記事の閲覧**
   - サイドバーの「記事・ニュース」をクリック
   - 公開されている記事が表示される
   - 記事カードをクリックして詳細を表示

2. **カテゴリフィルター**
   - 「すべて」「AIニュース」「使い方記事」のタブを切り替え
   - 正しくフィルタリングされることを確認

#### 管理者向け

1. **管理者パネルへアクセス**
   - 管理者権限でログイン
   - サイドバーの「管理者パネル」をクリック
   - 「記事管理」タブを開く

2. **記事の作成**
   - 「AI記事生成」ボタンをクリック
   - 記事情報を入力して生成
   - Supabaseダッシュボード → `articles` テーブルを確認
   - 記事が保存されていることを確認

3. **記事の編集**
   - 記事の「編集」ボタンをクリック
   - 内容を変更して保存
   - Supabaseで `updated_at` が更新されていることを確認

4. **公開/非公開の切り替え**
   - 「公開」または「非公開」ボタンをクリック
   - Supabaseで `is_published` フィールドが切り替わることを確認
   - 公開中の記事のみが記事ページに表示されることを確認

5. **記事の削除**
   - 記事を削除
   - Supabaseから削除されていることを確認
   - 記事ページから削除されることを確認

### 確認ポイント

✅ 公開記事のみが一般ユーザーに表示される
✅ 管理者は全記事（公開・非公開）を確認できる
✅ 記事のCRUD操作が正しく動作
✅ 公開状態の切り替えが正しく反映される

---

## 統計機能のテスト

### テスト手順

1. **プロンプトのコピー**
   - いくつかのプロンプトをコピー（3〜5個程度）
   - 同じプロンプトを複数回コピー

2. **Supabaseへのログ保存確認**
   - Supabaseダッシュボード → `copy_logs` テーブルを確認
   - コピーごとにログが記録されていることを確認
   - フィールド確認:
     - `user_id`: ユーザーID
     - `prompt_id`: プロンプトID
     - `created_at`: コピー日時

3. **統計ページの確認**
   - サイドバーの「統計」をクリック
   - 以下の情報が正しく表示されることを確認:
     - **総コピー数**: 全期間のコピー総数
     - **今日のコピー数**: 本日のコピー数
     - **今月のコピー数**: 今月のコピー数
     - **よく使うプロンプト TOP 10**: 使用頻度順のランキング
     - **使用推移グラフ**: 過去30日間の日別コピー数
     - **最近の使用履歴**: 直近20件の履歴

4. **統計の更新確認**
   - 新しいプロンプトをコピー
   - 統計ページをリロード
   - 数値が更新されていることを確認

### 確認ポイント

✅ プロンプトコピー時にSupabaseにログが保存される
✅ 統計データがSupabaseから正しく取得・計算される
✅ グラフが正しく表示される
✅ リアルタイムで統計が更新される

---

## デバイス間同期のテスト

### テスト手順

1. **デバイスAでの操作**
   - デバイスA（例: PC）でログイン
   - お気に入りを追加
   - カスタムプロンプトを作成
   - フォルダを作成してプロンプトを追加
   - プロンプトをコピー

2. **デバイスBでの確認**
   - デバイスB（例: スマホ）で同じアカウントでログイン
   - デバイスAで追加したお気に入りが表示される
   - デバイスAで作成したカスタムプロンプトが表示される
   - デバイスAで作成したフォルダとその中身が表示される
   - 統計ページでデバイスAでのコピー履歴が反映される

3. **双方向同期の確認**
   - デバイスBで新しいお気に入りを追加
   - デバイスAでリロード
   - デバイスBでの操作が反映されることを確認

### 確認ポイント

✅ 同じアカウントでログインすると全データが同期される
✅ 一方のデバイスでの操作がもう一方に反映される
✅ リアルタイム性が保たれる（リロードで最新データが取得される）

---

## トラブルシューティング

### データが保存されない場合

1. **Supabase接続の確認**
   ```javascript
   // ブラウザのコンソールで実行
   console.log(import.meta.env.VITE_SUPABASE_URL);
   console.log(import.meta.env.VITE_SUPABASE_ANON_KEY);
   ```
   - 環境変数が正しく読み込まれているか確認

2. **ネットワークエラーの確認**
   - DevTools → Network タブを開く
   - Supabaseへのリクエストが成功しているか確認
   - エラーレスポンスがある場合は内容を確認

3. **テーブルの存在確認**
   - Supabaseダッシュボードで必要なテーブルが作成されているか確認
   - テーブル名のスペルミスがないか確認

### データが表示されない場合

1. **ブラウザのキャッシュをクリア**
   - ハードリロード（Ctrl + Shift + R / Cmd + Shift + R）

2. **ログイン状態の確認**
   - 正しくログインできているか確認
   - Clerkのセッションが有効か確認

3. **コンソールエラーの確認**
   - DevTools → Console タブでエラーメッセージを確認

---

## データベース構造の確認

### 各テーブルの確認方法

Supabaseダッシュボード → Table Editor で以下を確認:

#### user_favorites
```sql
SELECT * FROM user_favorites WHERE user_id = 'your-user-id';
```

#### custom_prompts
```sql
SELECT * FROM custom_prompts WHERE user_id = 'your-user-id';
```

#### user_folders
```sql
SELECT * FROM user_folders WHERE user_id = 'your-user-id';
```

#### articles
```sql
SELECT * FROM articles WHERE is_published = true;
```

#### copy_logs
```sql
SELECT * FROM copy_logs WHERE user_id = 'your-user-id' ORDER BY created_at DESC LIMIT 20;
```

---

## まとめ

すべての機能が正しく動作すれば、以下が実現されています:

✅ **お気に入り**: デバイス間で同期
✅ **カスタムプロンプト**: クラウドに保存、どこからでもアクセス可
✅ **フォルダ**: プロンプトの整理がデバイス間で同期
✅ **記事**: 管理者が作成・編集、全ユーザーが閲覧可
✅ **統計**: 使用状況がクラウドで集計、デバイス間で統合表示

不明点や問題があれば、コンソールのエラーメッセージとSupabaseのログを確認してください。
